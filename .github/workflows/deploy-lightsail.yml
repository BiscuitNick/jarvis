name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  DEPLOYMENT_PATH: /opt/jarvis

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Run linting
        run: |
          if [ -f "package.json" ] && npm run lint --if-present; then
            echo "Linting passed"
          else
            echo "No linting script found, skipping"
          fi

      - name: Run tests
        run: |
          if [ -f "package.json" ] && npm test --if-present; then
            echo "Tests passed"
          else
            echo "No tests found, skipping"
          fi

  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          # Build images for each service when they exist
          # docker-compose -f infrastructure/docker/docker-compose.yml build

      - name: Save build artifacts
        run: |
          echo "Build completed successfully"

  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          SSH_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to Lightsail
        env:
          SSH_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          SSH_USER: ${{ secrets.LIGHTSAIL_USER || 'ubuntu' }}
        run: |
          ssh -i ~/.ssh/lightsail_key $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e

            # Navigate to deployment directory
            cd $DEPLOYMENT_PATH || { echo "Deployment directory not found"; exit 1; }

            # Pull latest changes
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              echo "Git repository not initialized"
              exit 1
            fi

            # Stop services gracefully
            cd infrastructure/docker
            docker-compose down --timeout 30

            # Pull latest images (if using pre-built images)
            # docker-compose pull

            # Start services
            docker-compose up -d --build

            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 30

            # Check service health
            docker-compose ps

            # Cleanup old images
            docker image prune -f

            echo "Deployment completed successfully"
          ENDSSH

      - name: Health Check
        env:
          SSH_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          SSH_USER: ${{ secrets.LIGHTSAIL_USER || 'ubuntu' }}
        run: |
          ssh -i ~/.ssh/lightsail_key $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd $DEPLOYMENT_PATH/infrastructure/docker

            # Check if all services are running
            if docker-compose ps | grep -q "Exit"; then
              echo "Some services failed to start"
              docker-compose logs --tail=50
              exit 1
            fi

            # Test health endpoints
            curl -f http://localhost/health || { echo "Health check failed"; exit 1; }

            echo "All health checks passed"
          ENDSSH

      - name: Rollback on Failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          SSH_USER: ${{ secrets.LIGHTSAIL_USER || 'ubuntu' }}
        run: |
          echo "Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/lightsail_key $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd $DEPLOYMENT_PATH/infrastructure/docker

            # Rollback to previous version
            git checkout HEAD~1
            docker-compose up -d --build

            echo "Rollback completed"
          ENDSSH

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
          fi

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/lightsail_key
